<%- include("../partials/header"); -%>
  <style>
    .update-btn {
  display: none;
    }
  .leave-report-box {
    display: grid;
    grid-template-columns: 1fr  1fr;
    justify-items: center;
    align-items: center;
    gap: 20px;
    width:600px;
    height: 200px;
    padding: 12px;
    border: 1px solid #e6e6e6;
    border-radius: 15px;
    margin: auto;
}
.leave-profile{
  display: grid;
  grid-template-columns: 1fr 3fr;
 align-self: center;
  gap: 20px;
}
.leave-profile .username{
  font-size: 22px;
  font-weight: 600;
}
.leave-profile-avatar {
 align-self: center;
  
}
.leave-profile-avatar img{
  width: 100px;
  height: 100px;
}
.leave-box tr td {
  line-height: 18px;
  font-size: 14px;
  font-weight: 600;
  color: #3d4e5e;
}
.leave-box {
  width: 250px;
  height: 165px;
  padding: 14px;
  border: 1px solid #e6e6e6;
  border-radius: 15px;
  background-color: var(--success-fade);
  text-transform: capitalize;
  margin: 6px;
}
.leave-box h2 {
  padding-bottom: 12px;
  font-size: 18px;
  font-weight: 700;
  color: var(--deep);
}
.leave-box td span {
  font-size: 12px;
  width: 500;
}
.leave-box tr td:nth-child(1) {
    padding-right: 10px;
}
.leave-profile-details{
  font-size: 14px;
  font-weight: 500;
  color: var(--black);
}
.leave-profile-details ,.email,.phone{
  margin:6px 0;
}
.search-user{
}
.user-list .user{
  width: 200px;
  margin: 8px;
  padding: 5px 5px;
  border: 1px solid #c8c8c8;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
}
.user-list .avatar img{
  width: 25px;
  height: 25px;
}

  </style>
<div id="users">
  <div class="text-head">
    <div class="text-title">Leave days</div>

    <%if(loggedInUser.userRole==='admin'){ %>

    <div class="" style="display:flex ;">
      <div class="add-button">
        <button class="add-btn">
          <span class="add-icon">
            <%- include("../partials/icons/add-svg"); -%>
          </span>
          <span class='add-btn-text'>Add Leave </span>
        </button>
      </div>
      <div class="add-button">
        <a class="a-link" href="/options/request-leave">
        <button class="add-btn">
            <span class="add-icon">
              <%- include("../partials/icons/request-svg"); -%>
            </span>
            <span class='add-btn-text'>Request Leave </span>
          </button>
        </div>
      </a>
      </div>
    <%}else{%>
      <div class="add-button">
        <button class="add-btn">
          <span class="add-icon">
            <%- include("../partials/icons/send-svg"); -%>
          </span>
          <span .add-btn-text>Request Leave </span>
        </button>
      </div>
      <% } %> 
  </div>
  <%if(loggedInUser.userRole==='admin'){ %>
  <%- include("../partials/add-leaveday-modal"); -%>
<% }else{ %>
  <%- include("../partials/add-request-leave-modal"); -%>
  <% } %>  
<div id="search-user" class="search-user">
   <input type="text" id="user" placeholder="Search User">
  <div id="user-list" class="user-list">
    <ul>
      <li>
       <div class="user">
         <div class="avatar">
           <img src="/uploads/avatars/demo-avatar.png" />
         </div>
         <div class="username">khoaiz</div>
       </div>
      </li>
      <li>
       <div class="user">
         <div class="avatar">
           <img src="/uploads/avatars/demo-avatar.png" />
         </div>
         <div class="username">khoaiz</div>
       </div>
      </li>
    </ul>
  </div>
</div>
  <!-- Markup Date range for employee-->
<div class="leave-report-box">
  <div class="leave-profile">
    <div class="leave-profile-avatar">
      <% if(userInfo.avatar !== null && userInfo.avatar.match(/^(http|https):/g)){ %>
          <img
          src="<%= userInfo.avatar%>"
          />
      <%} else{%>
        <img
        src="/uploads/avatars/<%=userInfo.avatar===null ? 'demo-avatar.png' : userInfo.avatar %>" />
        <% } %> 
    </div>
    <div class="leave-profile-info">
      <div class="username"><%= userInfo.user_name  %></div>
      <div class="role"><%= userInfo.user_role == "user" ? "Employee" : "Admin"  %> </div>
      <div class="leave-profile-details">
        <div class="email"><%= userInfo.user_mail %> </div>
        <div class="phone"><%= userInfo.user_phone %> </div>
        <div class="join-date"><%= userInfo.create_at %> </div>
      </div>
    </div>
  </div>
  <div class="filter-report">
    <div>
      <!-- Markup for  Today Box -->
      <div class="leave-box">
        <h2>This Year</h2>
        <div class="details">
          <table class="work">
            <tr>
              <td>Casual:</td>
              <td>22</td>
            </tr>
            <tr>
              <td>sick:</td>
              <td>2</td>
            </tr>
            <tr>
              <td>study:</td>
              <td>3</td>
            </tr>
            <tr>
              <td>unpaid:</td>
              <td>3</td>
            </tr>
          </table>
        </div>
      </div>
  </div>
</div>
</div>

  <div class="date-range-input">
    <div class="report-title-container">
      <h4>Reports</h4>
      <p class="report-title">In this year.</p>
    </div>
    <div class="date-picker">
      <div class="start-date">
        <input id="startPicker" type="text" placeholder="-- / -- / ----" />
      </div>
      <div class="to">to</div>
      <div class="end-date">
        <input id="endPicker" placeholder="-- / -- / ----" />
      </div>
      <div id="date-icon" class="date-icon">
        <svg
          width="26"
          height="30"
          viewBox="0 0 26 30"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M7.66667 1.66675V5.66675V1.66675ZM18.3333 1.66675V5.66675V1.66675ZM1.66667 11.1201H24.3333H1.66667ZM25 10.3334V21.6667C25 25.6667 23 28.3334 18.3333 28.3334H7.66667C3 28.3334 1 25.6667 1 21.6667V10.3334C1 6.33341 3 3.66675 7.66667 3.66675H18.3333C23 3.66675 25 6.33341 25 10.3334Z"
            stroke-width="2"
            stroke-miterlimit="10"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M8.05859 21.2666H8.07193M17.9266 17.2666H17.9386H17.9266ZM17.9266 21.2666H17.9386H17.9266ZM12.9933 17.2666H13.0066H12.9933ZM12.9933 21.2666H13.0066H12.9933ZM8.05859 17.2666H8.07193H8.05859Z"
            stroke-width="2.66667"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>
    </div>
  </div>

  <!-- Markup for leave days table  -->
  <div class="scroll-table">
    <table class="table leaveday-table">
      <thead>
        <tr>
          <td class="table-img"></td>

          <td class="td-width">Name</td>
          <td class="project-table-title td-width">Leave type</td>
          <td class="td-width">Start Date</td>
          <td class="td-width">End Date</td>
          <td class="td-width">Duration</td>
        </tr>
      </thead>
      <tbody id="leaveday-table">
        <%if(loggedInUser.userRole==='admin'){ %>
        <%employeeLeaveList.map((user,idx) =>{ %>
        <tr>
          <td class="table-img">
            <% if(user.avatar !== null && user.avatar.match(/^(http|https):/g)){
            %>
            <img src="<%= user.avatar%>" />
            <%} else{%>
            <img
              src="/uploads/avatars/<%=user.avatar != null ?  user.avatar : 'demo-avatar.png' %>"
            />
            <% } %>
          </td>
          <td class="td-width">
            <div class="username"><%=user.name%></div>
            <span id="role"><%= user.user_role==='admin'? 'admin' : ''%> </span>
          </td>
          <td class="td-width">
            <input class="reason-val" type="text" value="<%=user.type %>" />
          </td>
          <td class="td-width">
            <input class="start-val" type="text" value="<%=user.start%> " />
          </td>
          <td><input class="end-val" type="text" value="<%=user.end%>" /></td>
          <td class="duration td-width"><%= user.duration + ' ' + 'day' %></td>
          <td class="td-width">
            <div class="btn-group">
              <button type="button" class="action-btn">Action</button>
              <button type="button" class="update-btn">Update</button>
              <button type="button" class="save-btn">Save</button>
              <button type="button" class="opt-cancel-btn">Cancel</button>

              <input
                type="hidden"
                class="leave-id delete-id"
                value="<%= user.id %>"
              />
              <a class="delete-data"
                ><button class="delete-btn">Delete</button>
              </a>
            </div>
          </td>
        </tr>

        <% }) %> <%}else{%> <% anEmployeeLeavedaysList.map((user,idx) =>{ %>
        <tr>
          <td class="table-img td-width-zero">
            <% if(user.avatar !== null && user.avatar.match(/^(http|https):/g)){
            %>
            <img src="<%= user.avatar%>" />
            <%} else{%>
            <img
              src="/uploads/avatars/<%=user.avatar != null ?  user.avatar : 'demo-avatar.png' %>"
            />
            <% } %>
          </td>
          <td>
            <div class="username"><%=user.user_name%></div>
            <span id="role"><%= user.user_role==='admin'? 'admin' : ''%> </span>
          </td>
          <td>
            <input class="reason-val" type="text" value="<%=user.type %>" />
          </td>
          <td>
            <input class="start-val" type="text" value="<%=user.start%> " />
          </td>
          <td><input class="end-val" type="text" value="<%=user.end%>" /></td>
          <td class="duration"><%= user.duration + ' ' + 'day' %></td>
        </tr>

        <% }) %> <% } %>
      </tbody>
    </table>
    <!-- Markup for user delete modal -->

    <%- include("../partials/delete-modal.ejs"); -%>
    <!--- Markup for pagination -->

    <div class="pagination">
      <ul id="pagination"></ul>
    </div>
  </div>
</div>

<script>
  const baseUrl = "<%= baseUrl %>";
  const loggedInUser = "<%= loggedInUser.userRole %>";
</script>
<script src="<%=baseUrl%>/js/leaveday.js"></script>
<script>
  let typingTimer;
  const doneTypingInterval = 500;
  const input = document.querySelector("input#user");
  const users_placeholder = document.querySelector("#user-list");

  input.addEventListener("keyup", function () {
    clearTimeout(typingTimer);
    // reset
    if (input.value) {
      typingTimer = setTimeout(searchUsers, doneTypingInterval); //user is "finished typing," send search request
    }
  });
  //on keydown, clear the countdown
  input.addEventListener("keydown", function () {
    clearTimeout(typingTimer);
  });
  // send request for search
  async function searchUsers() {
    let response = await fetch("/user/search", {
      method: "POST",
      body: JSON.stringify({
        user: input.value,
      }),
      headers: {
        "Content-type": "application/json; charset=UTF-8",
      },
    });
    // get response
    let result = await response.json();
     console.log(result)
    // handle error and response
    if (result.errors) {
      const errorplaceholder = document.querySelector("p.error");
      errorplaceholder.textContent = result.errors.common.msg;
      errorplaceholder.style.display = "block";
    } else {
      if (result.length > 0) {
        let generatedHtml = "<ul>";
        result.forEach((user) => {
          let avatar;
          if(user.avatar !== null && user.avatar.match(/^(http|https):/g)){
            avatar = `<img
          src="${ user.avatar}"
          />`
          }else {
           avatar = `<img
        src="/uploads/avatars/${user.avatar===null ? 'demo-avatar.png' : user.avatar }" />`
          }
          generatedHtml += `<li >
              <div class="user">
                <div class="avatar">
                  ${avatar}
                </div>
                <div class="username">${user.user_name.split(' ')[0]}</div>
              </div>
            </li>`;
        });
        generatedHtml += "</ul>";
        users_placeholder.innerHTML = generatedHtml;
      }
    }
  }
  </script>
<%- include("../partials/footer"); -%>
